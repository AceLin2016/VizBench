<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html dir="ltr">
    
<head>
<meta name="viewport"
  content="width=device-width,
  minimum-scale=1.0, maximum-scale=1.0" />
<style type="text/css">
	body, html { font-family:helvetica,arial,sans-serif; font-size:90%; }
</style>
<style type="text/css">
    html, body { width: 100%; margin: 0; }
    button.incdec { width: 100%; }
    text.spacer { width: 30%; }
    td.valuelabel { width: 15%; text-align: center}
    td.valuevalue { width: 15%; text-align: center}
    td.buttontrio { width: 10%; text-align: center}
</style>

<script src="dojo/dojo.js" djConfig="parseOnLoad: true"> </script>
<script src="viz.js" djConfig="parseOnLoad: true"> </script>
<script type="text/javascript">

ParamList = null;

function readfile() {
	var paramfilename = dojo.byId("paramfilename");
	var filename = paramfilename.value;
	var api = doapi('VizServer.param_readfile','{ "file":"'+filename+'" }');
	var status = dojo.byId("status");
	if ( api.result == "" ) {
		status.innerHTML = "error="+api.error;
	} else {
		var j = JSON.parse(api.result);
		if ( j ) {
			for ( var name in j ) {
				var valueid = dojo.byId("value_"+name);
				if ( valueid ) {
					valueid.value = j[name];
				}
				var rangeid = dojo.byId("range_"+name);
				if ( rangeid ) {
					rangeid.value = j[name];
				}
			}
			status.innerHTML = "OK";
		} else {
			status.innerHTML = "Unable to interpret JSON from VizServer";
		}
	}
}
function loaddefaults() {
	var paramfilename = dojo.byId("paramfilename");
	var filename = paramfilename.value;
	var status = dojo.byId("status");
	if ( ParamList == null ) {
		status.innerHTML = "No ParamList value!?";
		return;
	}
	for ( var name in ParamList ) {
		var obj = ParamList[name];
		var type = obj["type"];
		var dflt = obj["default"];
		var valueid = dojo.byId("value_"+name);
		if ( valueid ) {
			valueid.value = dflt;
		}
		var rangeid = dojo.byId("range_"+name);
		if ( rangeid ) {
			rangeid.value = dflt;
		}
	}
	status.innerHTML = "OK";
}

function writefile() {
	var paramfilename = dojo.byId("paramfilename");
	var contents = "";
	var sep = "{ ";
	for ( name in ParamList ) {
		var valueid = dojo.byId("value_"+name);
		contents += (sep+"\""+name+"\":\""+valueid.value+"\"");
		sep = ",";
	}
	contents += " }";
	var api = doapi('VizServer.param_writefile','{ "file":"'+paramfilename.value+'", "contents":'+contents+' }');
	var status = dojo.byId("status");
	if ( api.result == "" ) {
		status.innerHTML = "File "+paramfilename.value+" has been updated";
	} else {
		status.innerHTML = api.error;
	}
}

function changeparamfile() {
	var paramfilename = dojo.byId("paramfilename");
	var paramfile = dojo.byId("paramfile");
	var val = paramfile.value;
	var words = val.split(/[\\\/]/);
	if ( words.length > 1 ) {
		val = words[words.length-1];
	}
	paramfilename.value = val;
	readfile();
}
function browsefile() {
	var paramfile = dojo.byId("paramfile");
	paramfile.click();
}

function changeval(name) {
	var valueid = dojo.byId("value_"+name);
	var rangeid = dojo.byId("range_"+name);
	valueid.value = rangeid.value;
}

function updateval(name) {
	changeval(name);

	var autosave = dojo.byId("autosave");
	var paramfilename = dojo.byId("paramfilename");
	if ( autosave.checked && paramfilename.value != "" ) {
		writefile()
	}
}

function setup() {

	var title = dojo.byId("title");
	var status = dojo.byId("status");
	var params = dojo.byId("params");

	var host = document.location.host;
	var i = host.indexOf(":");
	var instancenum = 1;
	if ( i > 0 ) {
		var port = host.substr(i+1);
		instancenum = port - 4439;
	}
	title.innerHTML = "<h2>Params Editor</h2>"

	var html = "";

	html += "<input type=\"file\" style=\"display: none\" id=\"paramfile\" onChange=\"changeparamfile();\" >";
	html += "Filename: ";
	html += "<input type=\"text\" style=\"width: 50%\" id=\"paramfilename\">";
	html += "&nbsp;&nbsp;";
	html += "<p>";
	html += "<input type=\"button\" style=\"width:100px\" value=\"Browse\" onClick=\"browsefile();\">";
	html += "&nbsp;&nbsp;";
	html += "<input type=\"button\" style=\"width:100px\" value=\"Load\" onClick=\"readfile();\">";
	html += "&nbsp;&nbsp;";
	html += "<input type=\"button\" style=\"width:100px\" value=\"Defaults\" onClick=\"loaddefaults();\">";
	html += "&nbsp;&nbsp;";
	html += "<input type=\"button\" style=\"width:100px\" value=\"Save\" onClick=\"writefile();\">";
	html += "&nbsp;&nbsp;";
	html += "AutoSave<input type=\"checkbox\" id=\"autosave\" value=\"AutoSave\" >";
	html += "<p>";

	var api = doapi('VizServer.param_list');
	if ( api.result == "" ) {
		status.innerHTML = api.error;
	} else {
		status.innerHTML = "OK";
		html += "<table>";
		var j = JSON.parse(api.result);
		if ( ! j ) {
			status.innerHTML = "Unable to parse VizServer.param_list result as JSON?";
			ParamList = null;
		} else {
		    ParamList = j;
		    for ( var name in ParamList ) {
			if ( ! ParamList.hasOwnProperty(name) ) {
				continue;
			}
			html += "<tr>";
			var obj = ParamList[name];
			var type = obj["type"];
			var mn = obj["min"];
			var mx = obj["max"];
			var stepsize = (mx-mn)/20.0;

			html += "<td>"+name+"</td>";
			var valueid = "value_"+name;
			if ( type == "int" || type == "double" ) {
				html += "<td><input id=\""+valueid+"\" type=\"number\" min=\""+mn+"\" max=\""+mx+"\" ></td>";
			} else {
				html += "<td><input id=\""+valueid+"\" type=\"text\" ></td>";
			}
			// html += "<td>"+mn+"</td><td>"+mx+"</td>";
			html += "<td>";

			var rangeid = "range_"+name
			if ( type == "int" ) {
				html += "<input id=\""+rangeid+"\" type=\"range\" min=\""+mn+"\" max=\""+mx+"\" oninput=\"changeval('"+name+"');\" onchange=\"updateval('"+name+"');\" >";
			} else if ( type == "double" ) {
				html += "<input id=\""+rangeid+"\" type=\"range\" min=\""+mn+"\" max=\""+mx+"\" step=\""+stepsize+"\" oninput=\"changeval('"+name+"');\" onchange=\"updateval('"+name+"');\" >";
			} else if ( type == "bool" ) {
				html += "<input id=\""+rangeid+"\" type=\"range\" min=\"0\" max=\"1\" step=\"1\">";
			} else if ( type == "string" ) {
			}
			html += "</td>";
			html += "</tr>";
		    }
		}
	}

	params.innerHTML = html;

	// var viztags = doapi('viztags').result;

	// if ( viztags == "" ) {
	// 	plugins.innerHTML = "No viz plugins are present.";
	// 	return;
	// }

//	var plugins = dojo.byId("vizplugins");
//
//	var tags = viztags.split(",");
//	var r;
//	for ( var i=0; i<tags.length; i++ ) {
//		tag = tags[i];
//		html += "<p><hr>"+tag+"\n";
//
//		var desc = doapi(tag+'.description').result;
//		html += "<p>Description: "+desc + "\n";
//
//		var about = doapi(tag+'.about').result;
//		html += "<p>About: "+about + "\n";
//
//		var apis = doapi(tag+'.apis').result;
//		if ( apis == "" ) {
//			html += "<p>No APIs";
//		} else {
//			html += "<table>";
//			html += "<tr><td>APIs:</td></tr>";
//
//			var a = apis.split(";");
//			for ( var n=0; n<a.length; n++ ) {
//				html += "<tr><td></td>";
//				var w = a[n].split(/[\(\)]/);
//				// We expect the length of w to be either 1 (just an api name) or
//				// 3 (api name + argument)
//				var api = w[0];
//				var fullapiname = tag + "." + api;
//				if ( w.length <= 1 ) {
//					html += "<td><input type=\"button\" style=\"width:100px\" value=\""+a[n]+"\" onClick=\"doapi('"+fullapiname+"');\"></td>";
//				} else if ( w.length != 3 ) {
//					alert("Hey, too many arguments on api="+w[0]+" length="+w.length+" an="+a[n]);
//				} else {
//					var args = w[1].split(",");
//
//					var argname = args[0];
//					var inputid = tag+"_"+api;
//					var argstr = "&quot;" + argname + "&quot; : "
//						+ "&quot;'+document.getElementById(&quot;" + inputid + "&quot;).value+'&quot;";
//
//					html += "<td><input type=\"button\" style=\"width:100px\" value=\""
//						+api+"\" onClick=\"doapi('"+fullapiname+"','{"+argstr+"}');\"></td>";
//
//					html += "<td width=10></td><td align=right>"
//						+argname+"&nbsp;=&nbsp;</td><td><input type=\"text\" id=\""+inputid+"\" size=8></td>";
//				}
//				html += "</tr>";
//			}
//			html += "</table>";
//		}
//	}
//	plugins.innerHTML = html;
//
//	// After the HTML is all done and enabled, set the values using any apis that start with "set_"
//	for ( var i=0; i<tags.length; i++ ) {
//		tag = tags[i];
//		var apis = doapi(tag+'.apis').result;
//		if ( apis != "" ) {
//			var a = apis.split(";");
//			for ( var n=0; n<a.length; n++ ) {
//				html += "<tr><td></td>";
//				var w = a[n].split(/[\(\)]/);
//				if ( w.length <= 1 ) {
//					continue;
//				}
//				var api = w[0];
//				var args = w[1].split(",");
//				if ( api.search("set_") != 0 ) {
//					continue;
//				}
//				argname = api.substring(4);
//				var getapi = tag + ".get_" + argname;
//				var val = doapi(getapi).result;
//				var inputid = tag+"_"+api;
//				document.getElementById(inputid).value = val;
//			}
//		}
//	}
}

dojo.addOnLoad(setup);
</script>
</head>
    
<body class="claro">

<center>
<div id="title">&nbsp;</div>
<br>
</center>
<p>
<table><tr><td>Status:</td><td><div id="status"></div></td></tr></table>
<p>
<div id="params"></div>
<p>
	
</body>

</html>

