<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html dir="ltr">
    
<head>
<meta name="viewport"
  content="width=device-width,
  minimum-scale=1.0, maximum-scale=1.0" />

<link rel="stylesheet" type="text/css" href="viz.css"/>

<script src="../dojo/dojo.js" djConfig="parseOnLoad: true"> </script>
<script src="viz.js" djConfig="parseOnLoad: true"> </script>
<script type="text/javascript">

var autosave = true;

function setup() {

	// titlegen("FFFF Home","");

	pipelines_pagegen();

	vizserver_pagegen();

	refresh_all();
}

function refresh_checkbox(name) {
	var api = vizapi("ffff.get_"+name);
	if ( checkapi(api) ) {
		document.getElementById(name).checked = api.result;
	}
}

function refresh_all() {

	var api = vizapi("ffff.get_pipeset");
	if ( checkapi(api) ) {
		document.getElementById("pipeset").value = api.result;
	} else {
		// alert("Failed to get_pipeset, aborting refresh_all");
		return;
	}

	refresh_checkbox("showfps");
	// refresh_checkbox("autoload");
	// refresh_checkbox("autosave");

	refresh_pipeline(0);
	refresh_pipeline(1);
	refresh_pipeline(2);
	refresh_pipeline(3);
}

function ffff_loadsave() {
	var html = "";

	html += "<font style=\"width:200px; font-size: 200%\";\">";
	html += "PipeSet - &nbsp;&nbsp;&nbsp;";
	html += "<input type=\"text\" style=\"width:200px; font-size: 100%\" id=\"pipeset\" onChange=\"change_pipeset();\" onKeypress=\"keypress_pipeset(event);\" >";

	html += "</font>";

	return html;

	// html += "<input type=\"file\" style=\"display: none\" id=\"pipesetfile\" >";


	// html += "</td><td>";
	html += "&nbsp;&nbsp;";

	// html += "<input type=\"button\" style=\"width:100px\" value=\"Browse\" onClick=\"browse_pipeset();\">";
	// html += "&nbsp;&nbsp;";
	// html += "<input type=\"button\" style=\"width:100px\" value=\"Load\" onClick=\"load_pipeset();\">";
	// html += "&nbsp;&nbsp;";
	// html += "<input type=\"button\" style=\"width:100px\" value=\"Save\" onClick=\"save_pipeset();\">";


	// html += "<td>Show FPS: <input type=\"checkbox\" id=\"showfps\" onChange=\"change_showfps();\"></td>";
	// html += "<td>Autoload pipelines: <input type=\"checkbox\" id=\"autoload\" onChange=\"change_autoload();\"></td>";
	// html += "<td>Autosave pipeset: <input type=\"checkbox\" id=\"autosave\" onChange=\"change_autosave();\"></td>";

}

function onepipeline(pipenum) {

	var pipelineid = "pipeline_"+pipenum;
	var sidrangeid = "sidrange_"+pipenum;

	html = "";
	html += "<tr><td>";
	html += "Pipeline "+pipenum+": </td><td>";

	// The pipeline value only gets looked at when you hit Enter
	html += "<input type=\"text\" style=\"width:150px\" id=\""+pipelineid+"\" onKeypress=\"keypress_pipeline(event,"+pipenum+");\" >";

	html += "&nbsp;&nbsp;";
	html += "SidRange: ";
	html += "<input type=\"text\" style=\"width:90px\" id=\""+sidrangeid+"\" onChange=\"change_sidrange("+pipenum+");\" >";
	html += "&nbsp;&nbsp;";
	html += "<input type=\"button\" style=\"width:100px\" value=\"Edit\" onClick=\"edit_pipeline("+pipenum+");\">";
	html += "&nbsp;&nbsp;";
	html += "<input type=\"button\" style=\"width:100px\" value=\"Edit Temp\" onClick=\"edit_pipeline_tmp("+pipenum+");\">";
	html += "&nbsp;&nbsp;";
	html += "<input type=\"button\" style=\"width:100px\" value=\"Use Temp\" onClick=\"use_pipeline_tmp("+pipenum+");\">";
	html += "&nbsp;&nbsp;";

	var enabledid = "enabled_"+pipenum;
	var enabledchecked = "checked=\"checked\"";
	
	html += " Enabled:<input type=\"checkbox\"" + enabledchecked + " id=\""+enabledid+"\" onChange=\"enable_pipeline("+pipenum+");\">";

	html += "</td></tr>";

	return html;
}

function pipelines_pagegen() {

	var html = "";

	html += ffff_loadsave();

	html += "<hr>\n";
	html += "<table>";
	html += onepipeline(0);
	html += onepipeline(1);
	html += onepipeline(2);
	html += onepipeline(3);
	html += "</table>";

	html += "<hr>\n";

	document.getElementById("pipelines").innerHTML = html;
}

function vizserver_pagegen() {
	var html = "";

	html += "Show FPS: <input type=\"checkbox\" id=\"showfps\" onChange=\"change_showfps();\">";

	html += "<br><a href=\"vizserver.html\">VizServer control</a>";

	document.getElementById("vizserver").innerHTML = html;
}

function change_pipeset() {
	// Maybe this should just blindly load the pipeset, rather than
	// try to be clever and only load it if it changes?
	var api = vizapi("ffff.get_pipeset");
	if ( ! checkapi(api) ) {
		return;
	}
	var current_pipeset = api.result;
	var fname = document.getElementById("pipeset").value;
	if ( fname != current_pipeset ) {
		load_pipeset();
	}
}

function keypress_pipeset(e) {
	if ( e.keyCode == 13 ) {
		load_pipeset();
	}
}

// function browse_pipeset() {
// 	var id = document.getElementById("pipesetfile");
// 	id.click();
// }

function load_pipeset() {
	var fname = document.getElementById("pipeset").value;
	if ( checkapi(vizapi("ffff.load_pipeset","{\"filename\":\""+fname+"\" }")) ) {
		refresh_all();
		set_status("Pipeset loaded!");
	}
}

function save_pipeset() {
	var pipeset = document.getElementById("pipeset").value;
	checkapi(vizapi("ffff.save_pipeset","{\"filename\":\""+pipeset+"\" }"));
}

function keypress_pipeline(e,pipenum) {
	if ( e.keyCode != 13 ) {
		return;
	}
	var id = "pipeline_"+pipenum;
	var obj = document.getElementById(id);
	checkapi(vizapi("ffff.load_pipeline","{\"pipenum\":\""+pipenum+"\", \"filename\":\""+obj.value+"\" }"));
	autosave_pipeset();
}

// function change_pipeline(pipenum) {
// 	var api = vizapi("ffff.ffglpipeline","{\"pipenum\":\""+pipenum+"\" }");
// 	if ( ! checkapi(api) ) {
// 		return;
// 	}
// 	var current_pipeline = api.result;
// 	var pipelineid = "pipeline_"+pipenum;
// 	var new_pipeline = document.getElementById(pipelineid).value;
// 	if ( new_pipeline != current_pipeline ) {
// 		checkapi(vizapi("ffff.load_pipeline","{\"pipenum\":\""+pipenum+"\", \"filename\":\""+new_pipeline+"\" }"));
// 	}
// 
// 	autosave_pipeset();
// }

function change_sidrange(pipenum) {
	var api = vizapi("ffff.get_sidrange","{\"pipenum\":\""+pipenum+"\" }");
	if ( ! checkapi(api) ) {
		return;
	}
	var current_sidrange = api.result;
	var sidrangeid = "sidrange_"+pipenum;
	var new_sidrange = document.getElementById(sidrangeid).value;
	if ( new_sidrange != current_sidrange ) {
		checkapi(vizapi("ffff.set_sidrange","{\"pipenum\":\""+pipenum+"\", \"sidrange\":\""+new_sidrange+"\" }"));
	}

	autosave_pipeset();
}

function enable_pipeline(pipenum) {
	var enabledid = document.getElementById("enabled_"+pipenum);
	var onoff = enabledid.checked ? "1" : "0";
	checkapi(vizapi("ffff.set_enablepipeline","{\"pipenum\":\""+pipenum+"\", \"onoff\":"+onoff+" }"));
	autosave_pipeset();
}

function change_showfps() {
	var id = document.getElementById("showfps");
	var onoff = id.checked ? "1" : "0";
	checkapi(vizapi("ffff.set_showfps","{\"onoff\":"+onoff+" }"));
}

// function change_autoload() {
// 	var id = document.getElementById("autoload");
// 	var onoff = id.checked ? "1" : "0";
// 	checkapi(vizapi("ffff.set_autoload","{\"onoff\":"+onoff+" }"));
// }

// function change_autosave() {
// 	var id = document.getElementById("autosave");
// 	var onoff = id.checked ? "1" : "0";
// 	checkapi(vizapi("ffff.set_autosave","{\"onoff\":"+onoff+" }"));
// }

function edit_pipeline(pipenum) {
	window.location.href = ("pipeline.html?pipenum="+pipenum);
}

function edit_pipeline_tmp(pipenum) {
	var id = "pipeline_"+pipenum;
	var obj = document.getElementById(id);
	var oldname = obj.value;
	var newname = obj.value + "_tmp";

	checkapi(vizapi("ffff.copy_pipeline","{\"pipenum\":\""+pipenum+"\", \"fromfile\":\""+oldname+"\", \"tofile\":\""+newname+"\" }"));

	checkapi(vizapi("ffff.load_pipeline","{\"pipenum\":\""+pipenum+"\", \"filename\":\""+newname+"\" }"));

	window.location.href = ("pipeline.html?pipenum="+pipenum);
}

function use_pipeline_tmp(pipenum) {
	var id = "pipeline_"+pipenum;
	var obj = document.getElementById(id);
	var newname = obj.value;
	var i = newname.indexOf("_tmp");
	if ( i <= 0 ) {
		alert("Hey, current pipeline doesn't end in _tmp !?");
		return;
	}
	var oldname = newname.substring(0,i);

	checkapi(vizapi("ffff.copy_pipeline","{\"pipenum\":\""+pipenum+"\", \"fromfile\":\""+newname+"\", \"tofile\":\""+oldname+"\" }"));

	checkapi(vizapi("ffff.load_pipeline","{\"pipenum\":\""+pipenum+"\", \"filename\":\""+oldname+"\" }"));

	obj.value = oldname;
}

function refresh_pipeline(pipenum) {

	// Refresh the pipeline filename value

	var api = vizapi("ffff.pipelinefilename","{\"pipenum\":\""+pipenum+"\"}");
	if ( checkapi(api) ) {
		var pipeline = api.result;
		var id = "pipeline_"+pipenum;
		document.getElementById(id).value = pipeline;
	}

	// Refresh the sidrange value

	api = vizapi("ffff.get_sidrange","{\"pipenum\":\""+pipenum+"\"}");
	if ( checkapi(api) ) {
		var sidrange = api.result;
		var id = "sidrange_"+pipenum;
		document.getElementById(id).value = sidrange;
	}

	// Refresh the enabled value

	api = vizapi("ffff.get_enablepipeline","{\"pipenum\":\""+pipenum+"\"}");
	if ( checkapi(api) ) {
		var id = "enabled_"+pipenum;
		document.getElementById(id).checked = api.result;
	}
}

function autosave_pipeset() {
	// var autosave = document.getElementById("autosave");
	var pipeset = document.getElementById("pipeset").value;
	if ( autosave && pipeset != "" ) {
		save_pipeset()
		refresh_all();
	}
}

dojo.addOnLoad(setup);
</script>
</head>
    
<body>

<div id="pipelines"></div>
<div id="status"></div>
<div id="vizserver"></div>
<p>
	
</body>

</html>

